language: nix

sudo: false

env:
  global:
    - CACHIX_CACHE=kreisys
    - NUR_REPO=kreisys/nur-packages
    # CACHIX_SIGNING_KEY
    - secure: "FS/7BVZa2lJvY8CUf7dsQHPx37EeNCNEaPi6aPDBMAv6O7cuEYO9NHpE2U2yz67XWbLPOXMCeRtZC64o2E7kxuTgC7c2xnuSXUBWmymBwy0r+v4+h5qPy/DDoT2iyi54H32lqMhE2HNBgTpL4elUhIK+80MUYVYv2KPFEYAAhe1dS1DY1BAFSNqp1aaF5YjCbDjgB/xIW77T5iAHd5o5PdpcSliKNWa0BrfnmmQVO6ulPFA9oUC43H2CI0heYSvIdTUSooQhRjLkAE1bYoDGAyi5r0jFplVk5PqPpFc1FMVba2Ch0UOoHD7KA2wILljQ576bw7IynhDy9O8xs6/+r6eDr5o8Wpk+tKGKgkC015MryG/6M8v3VeRs3+KRJlZ8KSldzqdzA14q6PKSw7XTE6Jm+u+ccAP+qe8jS9dw9tTIVziqd41aMfTLEshmghDABk5Lkg+UXF2eIrN1X0wDvtvVRQUCfKfJIRHBcP5x4gpRRF2wPBGw3ZwmYWfx5JxMAX5tZPugYJjqCqo3LUHeVsynXIMYP43g7FLEba9DhIR9pOz9+emzRNA/TEHv1fI670aJbaJ0DiDEvlvWIDBBUKa5r5gEQcr42LzVryT4bWs5jpwBBjevlTwUSLEsbvVo0I2n9XOg+4ezykWD/8V1ZIdHISMAjaQbAnEfq03yfu0="

install:
 - nix --version
 - travis_retry nix-channel --update
 - if [ -n "${CACHIX_CACHE}" ]; then nix-env -i cachix; fi
 - if [ -n "${CACHIX_CACHE}" ]; then cachix use "${CACHIX_CACHE}"; fi

script:
 - outs=$(nix-build non-broken.nix) && echo Produced $outs
 - nix eval -f default.nix 'lib'
 - nix eval -f default.nix 'modules'
 - nix eval -f default.nix 'overlays'

after_success:
  - if [ -n "${CACHIX_CACHE}" ]; then cachix push "${CACHIX_CACHE}" $outs; fi
  - if [ "false" = "${TRAVIS_PULL_REQUEST}" -a "master" = "${TRAVIS_BRANCH}" ]; then
      curl -XPOST "https://nur-update.herokuapp.com/update?repo=${NUR_REPO}"; fi

